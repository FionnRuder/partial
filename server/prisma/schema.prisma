generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================
// Enums
// ===================

enum Priority {
  Urgent
  High
  Medium
  Low
  Backlog
}

enum Status {
  ToDo
  WorkInProgress
  UnderReview
  Completed
}

// DeliverableType and IssueType are now table-based models to allow dynamic management
// See DeliverableType and IssueType models below

enum WorkItemType {
  Task
  Deliverable
  Issue
}

enum PartState {
  Released
  UnderReview
  InWork
  Implementation
}

enum UserRole {
  Admin
  Manager
  ProgramManager
  Engineer
  Viewer
}

// ===================
// Core Models
// ===================

model User {
  id                String   @id @default(cuid()) // Better Auth user ID
  organizationId    Int
  username          String
  name              String
  email             String
  phoneNumber       String
  role              UserRole
  profilePictureUrl String?
  disciplineTeamId  Int?

  // Email notification preferences (default to true for all)
  emailNotificationsEnabled Boolean @default(true)
  emailWorkItemAssignment   Boolean @default(true)
  emailWorkItemStatusChange Boolean @default(true)
  emailWorkItemComment      Boolean @default(true)
  emailInvitation           Boolean @default(true)
  emailApproachingDeadline  Boolean @default(true)

  organization   Organization    @relation(fields: [organizationId], references: [id])
  disciplineTeam DisciplineTeam? @relation(fields: [disciplineTeamId], references: [id])

  managedTeams      DisciplineTeam[] @relation("TeamManager")
  managedPrograms   Program[]        @relation("ProgramManager")
  authoredWorkItems WorkItem[]       @relation("WorkItemAuthor")
  assignedWorkItems WorkItem[]       @relation("WorkItemAssignee")

  partNumbers         Part[]
  attachments         Attachment[]
  comments            Comment[]
  statusLogs          StatusLog[]
  createdInvitations  Invitation[] @relation("InvitationCreator")
  acceptedInvitations Invitation[] @relation("InvitationAccepter")
  submittedFeedback   Feedback[]   @relation("FeedbackSubmitter")
  resolvedFeedback    Feedback[]   @relation("FeedbackResolver")
  auditLogs           AuditLog[]

  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  sessions      Session[]
  accounts      Account[]

  @@unique([organizationId, username])
  @@unique([organizationId, email])
  @@map("user")
}

model Organization {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users            User[]
  disciplineTeams  DisciplineTeam[]
  programs         Program[]
  parts            Part[]
  milestones       Milestone[]
  workItems        WorkItem[]
  attachments      Attachment[]
  comments         Comment[]
  statusLogs       StatusLog[]
  invitations      Invitation[]
  deliverableTypes DeliverableType[]
  issueTypes       IssueType[]
  feedback         Feedback[]
  auditLogs        AuditLog[]
}

model DisciplineTeam {
  id                Int     @id @default(autoincrement())
  organizationId    Int
  name              String
  description       String
  teamManagerUserId String?

  organization Organization              @relation(fields: [organizationId], references: [id])
  teamManager  User?                     @relation("TeamManager", fields: [teamManagerUserId], references: [id])
  users        User[]
  programs     DisciplineTeamToProgram[]
}

model Program {
  id                   Int      @id @default(autoincrement())
  organizationId       Int
  name                 String
  description          String
  programManagerUserId String?
  startDate            DateTime
  endDate              DateTime

  organization    Organization              @relation(fields: [organizationId], references: [id])
  programManager  User?                     @relation("ProgramManager", fields: [programManagerUserId], references: [id])
  partNumbers     Part[]
  disciplineTeams DisciplineTeamToProgram[]
  milestones      Milestone[]
  workItems       WorkItem[]
}

model DisciplineTeamToProgram {
  id               Int @id @default(autoincrement())
  disciplineTeamId Int
  programId        Int

  disciplineTeam DisciplineTeam @relation(fields: [disciplineTeamId], references: [id])
  program        Program        @relation(fields: [programId], references: [id])
}

model Milestone {
  id             Int      @id @default(autoincrement())
  organizationId Int
  name           String
  description    String
  date           DateTime
  programId      Int

  organization Organization @relation(fields: [organizationId], references: [id])
  program      Program      @relation(fields: [programId], references: [id])
  workItems    WorkItem[]
}

model Part {
  id             Int       @id @default(autoincrement())
  organizationId Int
  code           String    @map("number")
  partName       String
  level          Int
  state          PartState
  revisionLevel  String
  assignedUserId String
  programId      Int
  parentId       Int?

  organization Organization @relation(fields: [organizationId], references: [id])
  assignedUser User         @relation(fields: [assignedUserId], references: [id])
  program      Program      @relation(fields: [programId], references: [id])
  parent       Part?        @relation("ParentChildren", fields: [parentId], references: [id])
  children     Part[]       @relation("ParentChildren")

  workItemLinks WorkItemToPart[]

  @@unique([organizationId, code])
}

// ===================
// Base WorkItem + Subtypes
// ===================

model WorkItem {
  id                      Int          @id @default(autoincrement())
  organizationId          Int
  workItemType            WorkItemType
  title                   String
  description             String
  status                  Status
  priority                Priority
  tags                    String?
  dateOpened              DateTime     @default(now())
  dueDate                 DateTime
  estimatedCompletionDate DateTime
  actualCompletionDate    DateTime?
  percentComplete         Int
  inputStatus             String
  programId               Int
  dueByMilestoneId        Int
  authorUserId            String
  assignedUserId          String

  organization   Organization @relation(fields: [organizationId], references: [id])
  program        Program      @relation(fields: [programId], references: [id])
  dueByMilestone Milestone    @relation(fields: [dueByMilestoneId], references: [id])
  authorUser     User         @relation("WorkItemAuthor", fields: [authorUserId], references: [id])
  assigneeUser   User         @relation("WorkItemAssignee", fields: [assignedUserId], references: [id])

  // Relations
  partNumbers WorkItemToPart[]
  attachments Attachment[]
  comments    Comment[]
  statusLogs  StatusLog[]

  // Subtype details
  issueDetail       IssueDetail?
  deliverableDetail DeliverableDetail?
}

model IssueDetail {
  id               Int     @id
  issueTypeId      Int
  rootCause        String?
  correctiveAction String?

  workItem  WorkItem  @relation(fields: [id], references: [id])
  issueType IssueType @relation(fields: [issueTypeId], references: [id])
}

model DeliverableDetail {
  id                Int @id
  deliverableTypeId Int

  workItem        WorkItem        @relation(fields: [id], references: [id])
  deliverableType DeliverableType @relation(fields: [deliverableTypeId], references: [id])
}

// ===================
// Type Management Models
// ===================

model DeliverableType {
  id             Int      @id @default(autoincrement())
  organizationId Int
  name           String
  isSystem       Boolean  @default(false) // System types cannot be deleted
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization       Organization        @relation(fields: [organizationId], references: [id])
  deliverableDetails DeliverableDetail[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

model IssueType {
  id             Int      @id @default(autoincrement())
  organizationId Int
  name           String
  isSystem       Boolean  @default(false) // System types cannot be deleted
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id])
  issueDetails IssueDetail[]

  @@unique([organizationId, name])
  @@index([organizationId])
}

// ===================
// Linking Models
// ===================

model WorkItemToPart {
  id         Int @id @default(autoincrement())
  workItemId Int
  partId     Int

  workItem WorkItem @relation(fields: [workItemId], references: [id])
  part     Part     @relation(fields: [partId], references: [id])
}

model Attachment {
  id               Int      @id @default(autoincrement())
  organizationId   Int
  fileUrl          String
  fileName         String
  dateAttached     DateTime @default(now())
  uploadedByUserId String
  workItemId       Int?

  organization   Organization @relation(fields: [organizationId], references: [id])
  uploadedByUser User         @relation(fields: [uploadedByUserId], references: [id])
  workItem       WorkItem?    @relation(fields: [workItemId], references: [id])
}

model Comment {
  id              Int      @id @default(autoincrement())
  organizationId  Int
  text            String
  dateCommented   DateTime @default(now())
  commenterUserId String
  workItemId      Int?

  organization  Organization @relation(fields: [organizationId], references: [id])
  commenterUser User         @relation(fields: [commenterUserId], references: [id])
  workItem      WorkItem?    @relation(fields: [workItemId], references: [id])
}

model StatusLog {
  id             Int      @id @default(autoincrement())
  organizationId Int
  status         String
  dateLogged     DateTime @default(now())
  engineerUserId String
  workItemId     Int

  organization Organization @relation(fields: [organizationId], references: [id])
  engineerUser User         @relation(fields: [engineerUserId], references: [id])
  workItem     WorkItem     @relation(fields: [workItemId], references: [id])
}

model Invitation {
  id              Int       @id @default(autoincrement())
  organizationId  Int
  token           String    @unique // Cryptographically secure token
  invitedEmail    String? // Optional: restrict to specific email
  role            UserRole // Role to assign to the new user
  expiresAt       DateTime // Expiration date
  used            Boolean   @default(false)
  usedAt          DateTime?
  usedByUserId    String? // User who accepted the invitation
  createdByUserId String // User who created the invitation
  createdAt       DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  createdBy    User         @relation("InvitationCreator", fields: [createdByUserId], references: [id])
  usedBy       User?        @relation("InvitationAccepter", fields: [usedByUserId], references: [id])

  @@index([token])
  @@index([organizationId])
  @@index([invitedEmail])
}

model Feedback {
  id                Int       @id @default(autoincrement())
  organizationId    Int
  type              String // "bug", "feature", "improvement"
  title             String
  description       String
  status            String    @default("open") // "open", "in_progress", "resolved", "closed"
  priority          Priority  @default(Medium)
  submittedByUserId String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  resolvedAt        DateTime?
  resolvedByUserId  String?
  adminNotes        String? // Internal notes for admins

  organization Organization @relation(fields: [organizationId], references: [id])
  submittedBy  User         @relation("FeedbackSubmitter", fields: [submittedByUserId], references: [id])
  resolvedBy   User?        @relation("FeedbackResolver", fields: [resolvedByUserId], references: [id])

  @@index([organizationId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([submittedByUserId])
}

// ===================
// Audit Logging
// ===================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
}

model AuditLog {
  id             Int         @id @default(autoincrement())
  organizationId Int
  userId         String // User who performed the action
  action         AuditAction
  entityType     String // e.g., "WorkItem", "User", "Part", etc.
  entityId       Int? // ID of the affected entity (null for bulk operations)
  description    String // Human-readable description
  changes        Json? // JSON object with before/after values for updates
  metadata       Json? // Additional context (request path, query params, etc.)
  ipAddress      String? // IP address of the user
  userAgent      String? // User agent string
  requestId      String? // Request ID for tracing
  createdAt      DateTime    @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([action])
  @@index([createdAt])
  @@index([organizationId, entityType, entityId])
  @@index([organizationId, createdAt])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}
